<!DOCTYPE html>
<html>

<head>
    <title>B-Hub</title>
    <meta name="viewport" content="width=device-width,  initial-scale=1.0">
    <link rel="stylesheet" href="css/bhub.css" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
</head>

<body>
    <div style="width: 100%; height: 100%; position: absolute; overflow: hidden; overflow-y: scroll;">
        <h2
            style="position: relative; color: white; top: 40px; margin-left: 20px; margin-right: 47px; font-size: 24px;">
            Edit product</h2>

        <div id="product-holder" style="top: 30px;">
            <p id="svc-tool-tip">
                Other products*
            </p>
            <div
                style="position: relative;  margin-top: 20px; margin-left: 20px; align-items: start; justify-content: left; display: flex; margin-right: 20px;">
                <input type="text" placeholder="Product name here ..." required id="input-prod-name" />
            </div>
            <div
                style="height: 300px; position: relative; border: 1px solid darkgrey; border-radius: 6px; margin-top: 20px; margin-left: 20px; margin-right: 20px; align-items: center; justify-content: center; display: flex;">
                <img id="product-image" src="images/b_hub_logo.png" />
            </div>
            <input type="file" id="input-img-url" />
            <input type="button" id="upload-img-btn" value="UPLOAD IMAGE" />

            <div
                style="position: relative;  margin-top: 20px; margin-left: 20px; align-items: start; justify-content: left; display: flex; margin-right: 20px;">
                <input type="text" placeholder="Quantity eg. 100ml ..." required id="input-prod-qty" />
            </div>

            <div
                style="position: relative;  margin-top: 10px; margin-left: 20px; align-items: start; justify-content: left; display: flex; margin-right: 20px;">
                <input type="number" placeholder="Product price here eg. 50000 ..." required id="input-prod-price" />
            </div>
            <div
                style="position: relative;  margin-top: 10px; margin-left: 20px; align-items: start; justify-content: left; display: flex; margin-right: 20px;">
                <input type="text" placeholder="Product description here ..." required id="input-prod-desc" />
            </div>
            <div
                style="position: relative;  margin-top: 10px; margin-left: 20px; align-items: start; justify-content: left; display: flex; margin-right: 20px;">
                <input type="text" placeholder="Offer here eg. save 10% (optional) ..." required id="input-prod-disc" />
            </div>
            <div style="width: 100%; position: relative; display: flex; align-items: center; justify-content: center;">
                <input type="button" id="save-pop-svc-btn" onclick="saveItem()" value="SAVE" />
                <input type="button" id="save-pop-svc-btn" onclick="deleteItem()" value="DELETE" />
            </div>
        </div>
        <div style="width: 100%; height: 100px; position: relative; top: 50px;"></div>
    </div>
    <div style="width: 100%; height: 60px; background-color: black; position: fixed; top: 0%;">
        <span id="close-window-btn" class="material-symbols-outlined">arrow_back</span>
    </div>
    <dialog id="alert-dialog">
        <div style="height: 100%;">
            <li style="position: relative; list-style-type: none; font-size: 17px; font-weight: 700;">Alert!</li>
            <li id="dlg-text">Salon services are required!</li>
            <div style="position: relative; margin-top: 20px; align-items: end; justify-content: end; display: flex;">
                <li id="dialog-yes-btn" onclick="closeDlg()">OK</li>
            </div>
        </div>
    </dialog>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="js/index.js"></script>
    <script>
        let userId = "";
        let category = "";
        let numOfSvc = 0;
        let imgdownloadUrl = "";
        let db = firebase.firestore();
        let svcName = localStorage.getItem("svc_name");
        let dlgText = document.getElementById('dlg-text');
        let alertDlg = document.getElementById('alert-dialog');

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                userId = user.uid;
                getServiceInfo(userId);
            }
        });

        function getServiceInfo(uid) {
            console.log(svcName);
            db.collection("BHub").doc(uid).collection("Products").doc(svcName).get().then((it) => {

                if (it.data() != null) {
                    imgdownloadUrl = it.data().poster;

                    document.getElementById('product-holder').style.display = "block";
                    document.getElementById('svc-tool-tip').innerHTML = `Product*`;
                    document.getElementById('input-prod-name').value = it.data().name;
                    document.getElementById('product-image').src = imgdownloadUrl;
                    document.getElementById('input-prod-disc').value = it.data().offer;
                    document.getElementById('input-prod-price').value = it.data().price;
                    document.getElementById('input-prod-desc').value = it.data().desc;

                    if(it.data().qty != null) {
                        document.getElementById('input-prod-qty').value = it.data().qty;
                    }
                    console.log(it.data());
                }
            });
        }

        const deleteItem = () => {
            db.collection("BHub").doc(userId)
                .collection("Products").doc(svcName).delete().then((d) => {
                    let = message = "Service deleted successfully";
                    dlgText.innerHTML = message;
                    alertDlg.showModal();
                });
        }

        document.getElementById('dialog-yes-btn').addEventListener('click', (e) => {
            close();
        });

        const saveItem = () => {
            console.log('clicked');
            let prodName = document.getElementById('input-prod-name').value;
            let prodPrice = document.getElementById('input-prod-price').value;
            let prodDesc = document.getElementById('input-prod-desc').value;
            let prodOffer = document.getElementById('input-prod-disc').value;
            let qty = document.getElementById('input-prod-qty').value;

            if (prodName == "" || imgdownloadUrl == "" || qty == "" || prodPrice == "" || prodDesc == "") {
                var message = "Fill all required fields";
                dlgText.innerHTML = message;
                alertDlg.showModal();
                return;
            }

            var map = {
                price: prodPrice,
                desc: prodDesc,
                offer: prodOffer,
                qty: qty
            }
            db.collection("BHub").doc(userId).collection("Products").doc(prodName).update(map).then(function (e) {
                var message = "Product saved successfully";
                dlgText.innerHTML = message;
                alertDlg.showModal();
            });
        }

        $('#upload-img-btn').click(function () {
            var prodName = document.getElementById('input-prod-name').value;
            if (prodName == "") {
                var message = "Product name is required!";
                document.getElementById('dlg-text').innerHTML = message;
                alertDlg.showModal();
                return;
            }
            $('#input-img-url').trigger('click');
        });

        $("#input-img-url").on("change", function (event) {
            if (!(/\.(png|jpg|jpeg)$/i).test(event.target.files[0].name)) {
                window.alert('File not suppoted, upload png, jpg or jpeg files only!');
                return;
            }
            var prodName = document.getElementById('input-prod-name').value;
            selectedImgUri = event.target.files[0];
            let fileName = selectedImgUri.name;
            firebase.auth().onAuthStateChanged(function (user) {
                var userId = user.uid;
                let storageRef = firebase.storage().ref("BHub/" + "Products/" + prodName + fileName);
                let uploadTask = storageRef.put(selectedImgUri);
                uploadTask.on("state_changed", (snapshot) => {
                    console.log(snapshot);
                    percentageVal = Math.floor((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                    console.log(percentageVal);
                    console.log(userId);
                }, (error) => {
                    console.log("Error is: " + error.message);
                }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        console.log("ImageLink: " + url);
                        imgdownloadUrl = url;
                        var map = {
                            poster: imgdownloadUrl,
                            name: prodName,
                            userID: userId
                        }
                        db.collection("BHub").doc(userId).collection("Products").doc(prodName).update(map).then(function (e) {
                            document.getElementById('product-image').src = url;
                        });
                    });
                });
            });
        });

        document.getElementById('close-window-btn').addEventListener('click', (e) => {
            close();
        });
    </script>
</body>

</html>