<!DOCTYPE html>
<html>

<head>
    <title>B-Hub</title>
    <meta name="viewport" content="width=device-width,  initial-scale=1.0">
    <link rel="stylesheet" href="css/bhub.css" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
</head>

<body>
    <div
        style="width: 100%; height: 70px; position: fixed; top: 20px; align-items: start; justify-content: left; display: flex;">
        <li id="close-maps" class="fa fa-arrow-left"></li>
        <input type="text" id="search-place-input" placeholder="Where are you?">
    </div>
    <div onclick="saveCurrLocation()"
        style="position: absolute; top: 80px; display: flex; align-items: start; justify-content: start; cursor: pointer;">
        <span style="color: orangered; margin-left: 4.8rem;" class="material-icons">near_me</span>
        <span style="color: orangered; margin-left: 20px;">Use current location</span>
    </div>
    <div id="search-place-result">

    </div>

    <script src="js/index.js"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyAcjDk14VvIuVQeFxNbxmrrLWTXPRr0Fw0&callback=initMap"
        async defer></script>
    <script>
        let userId = "";
        let deliverTo = "";
        let currLocation = "";
        let latitude = 0;
        let longitude = 0;
        let savedLocation = localStorage.getItem("place_name");
        var closeMaps = document.getElementById('close-maps');
        var input = document.getElementById('search-place-input');

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                userId = user.uid;
                getCurrentLocation(userId);
            }
        });

        function initMap() {
            var map = new google.maps.Map(document.getElementById('search-place-result'), {
                center: { lat: 0.3244032, lng: 32.571392 },
                zoom: 13,
                disableDefaultUI: true
            });
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(closeMaps);

            input.value = deliverTo;

            var autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);

            var infowindow = new google.maps.InfoWindow();
            var marker = new google.maps.Marker({
                map: map,
                anchorPoint: new google.maps.Point(0, -29)
            });

            autocomplete.addListener('place_changed', function () {
                infowindow.close();
                marker.setVisible(false);
                var place = autocomplete.getPlace();
                if (!place.geometry) {
                    window.alert("No geometry ruslts found!");
                    return;
                }

                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
                marker.setIcon(({
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(35, 35)
                }));
                marker.setPosition(place.geometry.location);
                marker.setVisible(true)

                var address = '';
                if (place.address_components) {
                    address = [
                        (place.address_components[0] && place.address_components[0].short_name || ''),
                        (place.address_components[1] && place.address_components[1].short_name || ''),
                        (place.address_components[2] && place.address_components[2].short_name || '')
                    ].join(' ');
                }
                currLocation = `${place.name}, ${address}`;
                console.log(currLocation);

                input.value = currLocation;

                infowindow.setContent('<div><strong>' + place.name + '</strong></br>' + address);
                infowindow.open(map, marker);

                firebase.auth().onAuthStateChanged(function (user) {
                    if (user) {
                        var userId = user.uid;
                        var map = {
                            deliverTo: place.name,
                            lat: "" + place.geometry.location.lat(),
                            lng: `${place.geometry.location.lng()}`
                        }
                        var db = firebase.firestore();
                        db.collection("BHub").doc(userId).update(map).then(function (e) {
                            window.alert(`Come to: ${place.name}, ${address}`);
                            close()
                        });
                    } else {
                        window.alert("User not Aunthenticated!");
                    }
                });
            });
        }

        function getCurrentLocation(uid) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    console.log(`Latitude: ${latitude}, Longitude: ${longitude}`);

                    var API_KEY_BHUB = "AIzaSyAcjDk14VvIuVQeFxNbxmrrLWTXPRr0Fw0";

                    fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&key=${API_KEY_BHUB}`)
                        .then(response => response.json())
                        .then(data => {
                            const placeName = data.results[0].formatted_address;
                            currLocation = placeName;
                            input.value = currLocation;
                            console.log(placeName);
                        }).catch(error => console.error('Error: ', error));
                });
            } else {
                console.log("Geolocation is not supported by this browser,");
            }
        }

        function saveCurrLocation() {
            var map = {
                deliverTo: currLocation,
                lat: "" + latitude,
                lng: `${longitude}`
            }
            var db = firebase.firestore();
            db.collection("BHub").doc(userId).update(map).then(function (e) {
                alert(`Come to: ${currLocation}`);
                window.close();
            });
        }

        document.getElementById('close-maps').addEventListener('click', (e) => {
            if (savedLocation != "") {
                window.open("checkout.html", "_self");
            } else {
                close();
            }
        });
    </script>
</body>

</html>