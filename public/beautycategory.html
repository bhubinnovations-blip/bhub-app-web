<!DOCTYPE html>
<html>

<head>
    <title>B-Hub</title>
    <meta name="viewport" content="width=device-width,  initial-scale=1.0">
    <link rel="stylesheet" href="css/bhub.css" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
</head>

<body>
    <div id="splash">
        <img style="filter: blur(7px); -webkit-filter: blur(7px);" src="images/b_hub_logo.png" />
    </div>
    <div
        style="width: 100%; height: 100%; position: fixed; background-image: linear-gradient(to bottom, #000000cc, black);">
    </div>
    <form>
        <div style="width: 100%; overflow: hidden; overflow-y: scroll;">
            <h2
                style="position: relative; color: white; top: 60px; margin-left: 20px; margin-right: 47px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 24px;">
                Your name, address and category</h2>
            <p
                style="position: relative; margin-top: 80px; margin-left: 20px; margin-right: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 15px; color: white;">
                Create your account to help us publish your business to customer, registration is free</p>
            <p
                style="position: relative; margin-top: 30px; margin-left: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 700; font-size: 15px; color: rgb(196, 194, 194);">
                Enter salon name and address*</p>
            <div style="position: relative;  margin-top: 10px; margin-left: 20px; margin-right: 20px; display: flex;">
                <input type="text" placeholder="Salon name here ..." required id="input-email" />
            </div>
            <div style="position: relative;  margin-top: 70px; margin-left: 20px; margin-right: 20px; display: flex;">
                <input type="text" placeholder="Salon address here ..." required id="input-area" />
            </div>
            <div style="position: relative; margin-top: 70px; margin-left: 20px; margin-right: 20px; border: 1px solid darkgray; border-radius: 5px; background-color: black;">
                <img id="img-category" src="images/b_hub_logo.png" />
            </div>
            <input type="file" id="input-img-url" />
            <input type="button" id="upload-img-btn" value="UPLOAD IMAGE" />
            <fieldset
                style="position: relative; margin-top: 30px; color: white; border-radius: 5px; margin-left: 20px; margin-right: 20px; font-size: 18px;">
                <legend>Select salon category*</legend>

                <div style="margin-top: 10px;">
                    <input type="radio" id="radio-unisex" name="salon" value="unisex" checked />
                    <label for="radio-unisex">&nbsp;&nbsp;Unisex</label>
                </div>

                <div style="margin-top: 20px;">
                    <input type="radio" id="radio-women" name="salon" value="women" />
                    <label for="radio-women">&nbsp;&nbsp;Womens'</label>
                </div>

                <div style="margin-top: 20px; margin-bottom: 10px;">
                    <input type="radio" id="radio-men" name="salon" value="men" />
                    <label for="radio-men">&nbsp;&nbsp;Mens'</label>
                </div>
            </fieldset>

            <div style="position: relative;  margin-top: 60px; margin-left: 20px; margin-right: 20px;">
                <button type="submit" id="submit-btn" style="border: none; outline: none;">Continue</button>
            </div>
            <div style="width: 100%; height: 200px; position: relative;"></div>
        </div>
    </form>
    <div style="width: 100%; height: 60px; background-color: black; position: fixed; top: 0%;">
        <span id="close-window-btn" class="material-symbols-outlined">arrow_back</span>
    </div>
    <dialog id="alert-dialog">
        <div style="height: 100%;">
            <li style="position: relative; list-style-type: none; font-size: 17px; font-weight: 700;">Alert!</li>
            <li id="dlg-text">Salon name and category are required!</li>
            <div style="position: relative; margin-top: 20px; align-items: end; justify-content: end; display: flex;">
                <li id="dialog-yes-btn" onclick="closeDlg()">OK</li>
            </div>
        </div>
    </dialog>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="js/index.js"></script>
    <script>
        let db = firebase.firestore();
        let alertDlg = document.getElementById('alert-dialog');
        let form = document.querySelector("form");
        let salonCat = "";
        let userId = "";

        firebase.auth().onAuthStateChanged(function (user) {
            if(user) {
                userId = user.uid;
                
                db.collection("BHub").doc(userId).get().then((it) => {
                    if(it.data() != null && it.data().name != null) {
                        console.log(it.data());
                        document.getElementById('input-email').value = it.data().name;
                        document.getElementById('input-area').value = it.data().location;

                        if(it.data().poster != null) {
                            document.getElementById('img-category').src = it.data().poster;
                        }

                        if(it.data().category != null) {
                            var category = it.data().category;
                            if(category == "unisex") {
                                document.getElementById('radio-unisex').checked = true;
                            } else if(category == "womens") {
                                document.getElementById('radio-women').checked = true;
                            } else if(category == "men") {

                            }
                        }
                    }
                });
            }
        });

        document.getElementById('close-window-btn').addEventListener('click', (e) => {
            window.close();
        });

        $('#img-category').click(function () {
            $('#input-img-url').trigger('click');
        });

        $('#upload-img-btn').click(function () {
            $('#input-img-url').trigger('click');
        });

        $("#input-img-url").on("change", function (event) {
            if (!(/\.(png|jpg|jpeg)$/i).test(event.target.files[0].name)) {
                window.alert('File not suppoted, upload png, jpg or jpeg files only!');
                return;
            }
            selectedImgUri = event.target.files[0];
            let fileName = selectedImgUri.name;
            firebase.auth().onAuthStateChanged(function (user) {
                var userId = user.uid;
                let storageRef = firebase.storage().ref("BHub/" + "Salons/" + userId + fileName);
                let uploadTask = storageRef.put(selectedImgUri);
                uploadTask.on("state_changed", (snapshot) => {
                    console.log(snapshot);
                    percentageVal = Math.floor((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                    console.log(percentageVal);
                    console.log(userId);
                }, (error) => {
                    console.log("Error is: " + error.message);
                }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        console.log("ImageLink: " + url);
                        imgdownloadUrl = url;
                        var map = {
                            poster: imgdownloadUrl
                        }
                        db.collection("BHub").doc(userId).update(map).then(function (e) {
                            document.getElementById('img-category').src = url;
                        });
                    });
                });
            });
        });

        form.addEventListener(
            "submit",
            (event) => {
                const name = document.getElementById('input-email').value;
                const address = document.getElementById('input-area').value;
                const data = new FormData(form);
                let output = "";
                for (const entry of data) {
                    output = `${entry[1]}\r`;
                }
                salonCat.innerText = output;
                console.log(`${name}" ", ${output}`);

                var map = {
                    name: name,
                    category: output,
                    location: address
                }
                db.collection("BHub").doc(userId).update(map).then( function() {
                    window.close();
                    window.open("services.html");
                });
                event.preventDefault();
            },
            false,
        );
    </script>
</body>

</html>